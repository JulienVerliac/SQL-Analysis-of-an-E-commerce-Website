SELECT
parse_date('%Y%m%d',date) as date,
geoNetwork.country as countries,
device.deviceCategory as device,
channelGrouping as channel,
hits.page.searchKeyword as searchKeyword,
COUNT(distinct visitId) as uniqueSearches,
COUNT(hits.page.searchKeyword) as numberOfSearchPageviews,
COUNT(CASE hits.isExit WHEN TRUE THEN 1 ELSE NULL END) as searchExits,
SUM(totals.transactions) as transactions,
SUM(totals.totalTransactionRevenue)/100000 as revenue

FROM `bigquery-public-data.google_analytics_sample.ga_sessions_*`,
UNNEST(hits) as hits

WHERE hits.page.searchKeyword IS NOT NULL 

GROUP BY 1,2,3,4,5
